
[漏洞介绍链接](http://www.cnnvd.org.cn/web/xxk/ldxqById.tag?CNNVD=CNNVD-201812-489)

nonecms 通过升级thinkphp框架的版本把漏洞修复了

查看 `thinkphp/library/think/App.php` 这个文件的修改历史

更新框架前是[5.1.0](https://github.com/top-think/framework/releases/tag/v5.1.0)
    
    const VERSION = '5.1.0';
    
更新框架后是5.1.31

    const VERSION = '5.1.31 LTS';

漏洞出现在以下文件

[Url.php](NoneCMS/thinkphp/library/think/route/dispatch/Url.php)

parseUrl方法里的代码

```php
            // 解析模块
            $module = $this->app->config('app_multi_module') ? array_shift($path) : null;
            if ($this->param['auto_search']) {
                $controller = $this->autoFindController($module, $path);
            } else {
                // 解析控制器
                $controller = !empty($path) ? array_shift($path) : null;
            }
    
            // 解析操作
            $action = !empty($path) ? array_shift($path) : null;
    
            // 解析额外参数
            if ($path) {
                if ($this->app['config']->get('url_param_type')) {
                    $var += $path;
                } else {
                    preg_replace_callback('/(\w+)\|([^\|]+)/', function ($match) use (&$var) {
                        $var[$match[1]] = strip_tags($match[2]);
                    }, implode('|', $path));
                }
            }
```
            
添加了以下代码
            
```php
            
        if ($this->param['auto_search']) {
            $controller = $this->autoFindController($module, $path);
        } else {
            // 解析控制器
            $controller = !empty($path) ? array_shift($path) : null;
        }

        /* **** 加入了这段代码
        
        if ($controller && !preg_match('/^[A-Za-z](\w|\.)*$/', $controller)) {
            throw new HttpException(404, 'controller not exists:' . $controller);
        }
        
        **** 加入了这段代码 ****/

        // 解析操作
        $action = !empty($path) ? array_shift($path) : null;
        
```
        
具体修改历史可以在以下链接找到

[Url.php 修改历史](https://github.com/top-think/framework/commits/5.1/library/think/route/dispatch/Url.php)

概括地说，就是把`library/think/route/dispatch/Module.php` 的代码移动到 `library/think/route/dispatch/Url.php`

经过多次改进之后，变成下面这个样子

```php

    if ($controller && !preg_match('/^[A-Za-z][\w|\.]*$/', $controller)) {
        throw new HttpException(404, 'controller not exists:' . $controller);
    }
    
```    
    
如果把这段代码去掉并访问以下链接 ,就会复现之前的漏洞，执行phpinfo函数

http://xxx.com/NoneCms/public/?s=index/\think\Request/input&filter=phpinfo&data=1